## 2026-02-22 — Phase 0: Types & Skeleton

Implemented:
- Created `src/watcher/types.ts` with all four type definitions (WatchOptions, WatchHandle, WatchBatch, WatchError) mirroring the spec exactly
- Created `src/watcher/index.ts` barrel exporting functions and types
- Created `src/watcher/watch-session.ts` stub with registry Map and function signatures (throw "Not implemented")
- Created empty `src/watcher/__tests__/` directory for upcoming tests

Files changed:
- src/watcher/types.ts (new)
- src/watcher/index.ts (new)
- src/watcher/watch-session.ts (new)

Verified: typecheck passes, all 421 tests pass.

## 2026-02-22 — Phase 0: Core Read Loop

Implemented:
- Implemented `watchSession()` in `src/watcher/watch-session.ts`: on init reads file size, sets `byteOffset`, registers `fs.watch` listener, returns `WatchHandle`
- On fs.watch change: reads new bytes via `Bun.file().slice().text()`, splits on `\n`, passes lines to `parseLine()`, collects non-null results
- Flushes immediately (no debounce) — calls `onMessages` with `WatchBatch` containing parsed messages and `byteRange`
- Added internal `WatcherState` type to track FSWatcher alongside handle
- Implemented minimal `stopWatching()` (closes fs.watch, removes from registry, sets stopped=true) and `stopAll()` for teardown

Files changed:
- src/watcher/watch-session.ts (rewritten from stub)

Verified: typecheck passes, all 421 tests pass.

## 2026-02-22 — Phase 0: Tracer Bullet Test

Implemented:
- Created `src/watcher/__tests__/helpers.ts` with temp file utilities: `createTempJsonl()` (creates empty .jsonl in temp dir with cleanup), `appendLines()` (appends newline-terminated lines)
- Created `src/watcher/__tests__/watch-session.test.ts` with two tests:
  - "delivers parsed messages with correct byteRange after file append" — appends two JSONL lines to empty file, asserts correct message kinds, lineIndex assignment, byteRange coverage, and handle state
  - "only tails new content appended after watcher starts" — pre-populates file, starts watcher, appends new line, verifies only new content is delivered and byteRange starts at initial file size
- Reuses parser test helpers (`makeUserPrompt`, `makeAssistantRecord`, `makeTextBlock`, `toLine`) for fixture data

Files changed:
- src/watcher/__tests__/helpers.ts (new)
- src/watcher/__tests__/watch-session.test.ts (new)

Verified: typecheck passes, all 423 tests pass (421 existing + 2 new).

## 2026-02-22 — Phase 1: Partial Line Buffering

Implemented:
- Added `lineBuffer: string` field to `WatcherState` interface, initialized to `""` on watcher creation
- Changed read-loop to prepend `lineBuffer` to new text before splitting on `\n`
- After splitting, `segments.pop()` captures any trailing incomplete segment as the new `lineBuffer` — only complete lines (before a `\n`) are passed to `parseLine`
- Refactored watcher creation to build `WatcherState` object before `fs.watch`, assigning `fsWatcher` after creation (avoids chicken-and-egg with closure needing state reference)
- Added `appendRaw()` helper to test utilities for writing text without auto-appending `\n`

Tests added:
- "buffers partial line and delivers only after completing newline" — writes a JSON line in two halves, asserts no callback after first half, one message after second half
- "lineBuffer is empty after a complete-line write" — writes a full line with `\n`, asserts message delivered and handle state correct

Files changed:
- src/watcher/watch-session.ts (modified — added lineBuffer to state, updated read loop)
- src/watcher/__tests__/helpers.ts (modified — added appendRaw)
- src/watcher/__tests__/watch-session.test.ts (modified — added 2 tests)

Verified: typecheck passes, all 425 tests pass (423 existing + 2 new).
