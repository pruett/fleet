## 2026-02-20 — Phase 0: Project Scaffolding + Types

Implemented the first task group from Phase 0 (Tracer Bullet).

### What was done
- Created `src/scanner/types.ts` with `ProjectSummary` and `SessionSummary` interfaces matching the spec
- Created `src/scanner/index.ts` with placeholder type re-exports
- Created `src/scanner/__tests__/fixtures/base-path/-Users-foo-code-bar/a1b2c3d4-...jsonl` — minimal 4-line transcript (snapshot, user prompt, assistant text, turn_duration)

### Files changed
- `src/scanner/types.ts` (new)
- `src/scanner/index.ts` (new)
- `src/scanner/__tests__/fixtures/base-path/-Users-foo-code-bar/a1b2c3d4-e5f6-7890-abcd-ef1234567890.jsonl` (new)

### Notes
- `bun install` was needed (no `node_modules` in worktree)
- Typecheck and all 387 existing parser tests pass
- Fixture uses sessionId matching the UUID filename, model `claude-sonnet-4-20250514`, 10 input / 20 output tokens

## 2026-02-20 — Phase 0: scanProjects implementation

Implemented `scanProjects(basePaths)` — the first function in the "Minimal scanProjects + scanSessions" task group.

### What was done
- Created `src/scanner/scan-projects.ts` with full `scanProjects` implementation:
  - Iterates base paths, reads directory entries
  - Skips non-directories, dot-prefixed dirs, and `memory` dir
  - Decodes path (`-` → `/`)
  - Calls `scanSessions` per project for `sessionCount` and `lastActiveAt`
  - Sorts results by `lastActiveAt` descending (nulls last)
  - Silently skips missing/unreadable base paths
- Created `src/scanner/scan-sessions.ts` as a stub (returns `[]`) — dependency for `scanProjects` to compile; will be implemented in next task

### Files changed
- `src/scanner/scan-projects.ts` (new)
- `src/scanner/scan-sessions.ts` (new — stub)

### Notes
- Typecheck passes, all 387 parser tests still pass
- `scanProjects` relies on `scanSessions` being sorted by `lastActiveAt` desc — uses `sessions[0]?.lastActiveAt ?? null` for project-level recency
- Path decoding is lossy (hyphens in original paths are ambiguous) — matches spec behavior

## 2026-02-20 — Phase 0: scanSessions implementation

Implemented `scanSessions(projectDir)` — the directory scanning and filtering logic for session files.

### What was done
- Replaced `src/scanner/scan-sessions.ts` stub with full implementation:
  - Reads directory entries from project dir (silently returns `[]` on error)
  - Skips directories (excludes subagent companion dirs)
  - Skips non-`.jsonl` files
  - Skips files whose stem is not a valid UUID (case-insensitive regex)
  - Calls `extractSessionSummary(filePath, sessionId)` for each valid file
  - Sorts results by `lastActiveAt` descending (nulls last)
- Created `src/scanner/extract-session-summary.ts` as a stub — returns a `SessionSummary` with the given `sessionId` and all other fields null/zero; will be implemented in next task

### Files changed
- `src/scanner/scan-sessions.ts` (replaced stub with full implementation)
- `src/scanner/extract-session-summary.ts` (new — stub)

### Notes
- Typecheck passes, all 387 parser tests still pass
- UUID regex: `/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i`
- Uses `node:path` `basename`/`extname` for robust filename parsing
- Same sorting pattern as `scanProjects` (nulls last via comparator)

## 2026-02-20 — Phase 0: extractSessionSummary implementation

Replaced the stub with full selective JSONL reading for session metadata.

### What was done
- Replaced `src/scanner/extract-session-summary.ts` stub with full implementation:
  - Reads file contents, splits into non-empty lines
  - Scans header lines (up to first non-meta user record) for: `startedAt` (earliest timestamp, including `snapshot.timestamp` for file-history-snapshot records), `firstPrompt` (first non-meta user message content, truncated to 200 chars), `cwd`, `gitBranch`
  - Scans backwards from end for `lastActiveAt` (first line with a `timestamp` field, since `system`/`turn_duration` records lack timestamps)
  - `slug` returns `null` — not present in the JSONL format
  - `model` returns `null` — deferred to Phase 1 (token aggregation)
  - Token fields stubbed to zero — deferred to Phase 1
  - Malformed JSON lines silently skipped
  - File read errors return empty summary (all null/zero)
  - Empty files return empty summary

### Files changed
- `src/scanner/extract-session-summary.ts` (replaced stub with full implementation)

### Notes
- Typecheck passes, all 387 parser tests still pass
- `startedAt` checks both top-level `timestamp` and `snapshot.timestamp` for file-history-snapshot records
- `lastActiveAt` scans backwards because the typical last line (`system`/`turn_duration`) has no timestamp — the last assistant or user record does
- `slug` is not in the JSONL format; may need a separate source or convention in a later phase

## 2026-02-20 — Phase 0: scan-projects.test.ts

Created the first scanner test file covering `scanProjects`.

### What was done
- Created `src/scanner/__tests__/scan-projects.test.ts` with 3 tests:
  - Scans fixture base path and verifies 1 project with correct `id`, `path`, `source`, `sessionCount`, `lastActiveAt`
  - Silently skips a missing base path (returns empty array)
  - Merges results from multiple base paths (one missing, one valid)

### Files changed
- `src/scanner/__tests__/scan-projects.test.ts` (new)

### Notes
- All 390 tests pass (387 parser + 3 new scanner), typecheck passes
- `lastActiveAt` is `2026-02-18T10:00:02.000Z` — the assistant record timestamp, not the system/turn_duration line which lacks a timestamp

## 2026-02-20 — Phase 0: scan-sessions.test.ts

Created the scanner test file covering `scanSessions`.

### What was done
- Created `src/scanner/__tests__/scan-sessions.test.ts` with 3 tests:
  - Scans fixture project dir and verifies 1 session with correct `sessionId`, `slug`, `firstPrompt`, `startedAt`, `lastActiveAt`
  - Silently returns empty for a missing project dir
  - Silently returns empty for a directory with no `.jsonl` session files
- Marked the **Verify** checkpoint as done — `bun test src/scanner` passes end-to-end (6 scanner tests)

### Files changed
- `src/scanner/__tests__/scan-sessions.test.ts` (new)
- `plans/project-scanner.md` (updated checkboxes)

### Notes
- All 393 tests pass (387 parser + 6 scanner), typecheck passes
- Phase 0 (Tracer Bullet) is now fully complete

## 2026-02-20 — Phase 1: Usage Extraction with Deduplication

Implemented token aggregation, deduplication, cost computation, and model extraction in `extractSessionSummary`.

### What was done
- Extended `src/scanner/extract-session-summary.ts` with full usage extraction:
  - Single forward pass now handles both header extraction and assistant record scanning
  - For each `"type":"assistant"` line: extracts `message.id`, `message.model`, `message.usage`
  - Deduplicates by `message.id` using a Map (last occurrence wins — handles streaming multi-block responses)
  - Sums deduplicated usage across all responses: `inputTokens`, `outputTokens`, `cacheCreationTokens`, `cacheReadTokens`
  - Imports `computeCost` from `src/parser/pricing.ts` to calculate cost per response, then sums
  - Extracts `model` from the first assistant record encountered
  - Handles missing/null usage fields gracefully (defaults to 0)

### Files changed
- `src/scanner/extract-session-summary.ts` (extended with usage extraction)
- `plans/project-scanner.md` (checked off 4 items)

### Notes
- All 393 tests pass (387 parser + 6 scanner), typecheck passes
- Existing Phase 0 tests unaffected — they don't assert on token/cost/model fields
- Cost is computed per-response (using each response's own model), then summed — handles multi-model sessions correctly
- `ResponseUsage` interface tracks per-response model to enable per-response cost calculation

## 2026-02-20 — Phase 1: Usage Tests

Created `extract-session-summary.test.ts` with 4 tests covering token aggregation, deduplication, cost computation, and unknown model handling.

### What was done
- Created 3 fixture JSONL files for usage test scenarios:
  - `multi-block-response.jsonl` — 3 assistant blocks sharing same `message.id` with escalating output tokens (10→30→50)
  - `multiple-responses.jsonl` — 2 responses with different `message.id`s, including cache tokens
  - `unknown-model.jsonl` — assistant with unrecognized model name
- Created `src/scanner/__tests__/extract-session-summary.test.ts` with 4 tests:
  - Multi-block deduplication: verifies only last block's usage counted (input=100, output=50)
  - Multiple responses: verifies usage summed across both (input=3000, output=600, cacheCreation=500, cacheRead=1100)
  - Cost verification: manual SONNET pricing computation → 0.020205 USD
  - Unknown model: cost=0, tokens still summed correctly (input=500, output=100)

### Files changed
- `src/scanner/__tests__/fixtures/multi-block-response.jsonl` (new)
- `src/scanner/__tests__/fixtures/multiple-responses.jsonl` (new)
- `src/scanner/__tests__/fixtures/unknown-model.jsonl` (new)
- `src/scanner/__tests__/extract-session-summary.test.ts` (new)
- `plans/project-scanner.md` (checked off 5 items)

### Notes
- All 397 tests pass (387 parser + 10 scanner), typecheck passes
- Phase 1 (Core: Token Aggregation + Cost) is now fully complete
- Used `toBeCloseTo` for float cost comparison to avoid IEEE 754 precision issues

## 2026-02-20 — Phase 2: Header Extraction Edge Cases

Added test coverage for header extraction edge cases in `extractSessionSummary`.

### What was done
- Created 3 fixture JSONL files:
  - `meta-only-prompts.jsonl` — snapshot + 2 meta user records + 1 assistant (no non-meta user)
  - `snapshot-only.jsonl` — snapshot record only (no user or assistant records)
  - `long-first-prompt.jsonl` — user record with content >200 chars
- Added 3 tests in `extract-session-summary.test.ts` under "header extraction edge cases" describe block:
  - Meta-only prompts: verifies `firstPrompt: null`, `cwd: null`, but model/tokens/timestamps still extracted
  - Snapshot-only: verifies `firstPrompt: null`, `model: null`, zero tokens, `startedAt` from snapshot.timestamp, `lastActiveAt: null`
  - Truncation: verifies `firstPrompt` truncated to exactly 200 chars
- Verified meta-handling (`isMeta` check) and truncation (200-char slice) were already implemented — this task adds test coverage

### Files changed
- `src/scanner/__tests__/fixtures/meta-only-prompts.jsonl` (new)
- `src/scanner/__tests__/fixtures/snapshot-only.jsonl` (new)
- `src/scanner/__tests__/fixtures/long-first-prompt.jsonl` (new)
- `src/scanner/__tests__/extract-session-summary.test.ts` (extended with 3 tests)
- `plans/project-scanner.md` (checked off 4 items)

### Notes
- All 400 tests pass (387 parser + 13 scanner), typecheck passes
- Both meta handling and truncation were already implemented in the Phase 0 `extractSessionSummary` code — this task confirmed correctness with dedicated tests
- `lastActiveAt` is null for snapshot-only because the file-history-snapshot record lacks a top-level `timestamp` (it's nested under `snapshot.timestamp`)

## 2026-02-20 — Phase 2: File & Directory Filtering

Added test coverage for all file and directory filtering behaviors in `scanSessions` and `scanProjects`.

### What was done
- Created `fixtures/filtering-base/` fixture structure with:
  - `-Users-test-project/` — valid project dir with 1 UUID session, 1 subdirectory (`subagent-companion/`), 1 `.txt` file, 2 non-UUID `.jsonl` files (`notes.jsonl`, `memory.jsonl`)
  - `memory/` — directory that should be skipped by `scanProjects`
  - `.hidden/` — dot-prefixed directory that should be skipped by `scanProjects`
- Added 3 tests in `scan-sessions.test.ts` under "file & directory filtering" describe block:
  - Directories inside project dir are skipped
  - Non-`.jsonl` files are skipped
  - Files with non-UUID names are skipped (e.g., `notes.jsonl`, `memory.jsonl`)
- Added 2 tests in `scan-projects.test.ts` under "directory filtering" describe block:
  - `memory` directory under base path is skipped
  - Dot-prefixed directories under base path are skipped

### Files changed
- `src/scanner/__tests__/fixtures/filtering-base/-Users-test-project/11111111-1111-1111-1111-111111111111.jsonl` (new)
- `src/scanner/__tests__/fixtures/filtering-base/-Users-test-project/subagent-companion/.gitkeep` (new)
- `src/scanner/__tests__/fixtures/filtering-base/-Users-test-project/notes.txt` (new)
- `src/scanner/__tests__/fixtures/filtering-base/-Users-test-project/notes.jsonl` (new)
- `src/scanner/__tests__/fixtures/filtering-base/-Users-test-project/memory.jsonl` (new)
- `src/scanner/__tests__/fixtures/filtering-base/memory/.gitkeep` (new)
- `src/scanner/__tests__/fixtures/filtering-base/.hidden/.gitkeep` (new)
- `src/scanner/__tests__/scan-sessions.test.ts` (extended with 3 tests)
- `src/scanner/__tests__/scan-projects.test.ts` (extended with 2 tests)
- `plans/project-scanner.md` (checked off 5 items)

### Notes
- All 405 tests pass (387 parser + 18 scanner), typecheck passes
- All filtering logic was already implemented — this task adds explicit test coverage
- Used `.gitkeep` files in directories so git tracks the empty fixture dirs

## 2026-02-20 — Phase 2: Resilience

Added test coverage for all resilience behaviors in `extractSessionSummary` and `scanProjects`.

### What was done
- Created 3 fixture files for resilience test scenarios:
  - `malformed-lines.jsonl` — 4 lines of broken JSON (no valid records)
  - `empty-session.jsonl` — completely empty file (0 bytes)
  - `mixed-valid-malformed.jsonl` — 3 malformed lines interleaved with 1 valid user and 1 valid assistant record
- Created `fixtures/resilience-base/-Users-empty-project/.gitkeep` — empty project directory fixture
- Added 4 tests in `extract-session-summary.test.ts` under "resilience" describe block:
  - Malformed JSON lines: all fields null/zero, no throw
  - Empty file: all fields null/zero
  - Missing file path: empty summary returned
  - Mixed valid/malformed: correct partial results (firstPrompt, cwd, gitBranch, model, tokens, timestamps extracted from valid lines)
- Added 2 tests in `scan-projects.test.ts` under "resilience" describe block:
  - Empty project directory: sessionCount=0, lastActiveAt=null
  - Missing base path: silently skipped, no throw

### Files changed
- `src/scanner/__tests__/fixtures/malformed-lines.jsonl` (new)
- `src/scanner/__tests__/fixtures/empty-session.jsonl` (new)
- `src/scanner/__tests__/fixtures/mixed-valid-malformed.jsonl` (new)
- `src/scanner/__tests__/fixtures/resilience-base/-Users-empty-project/.gitkeep` (new)
- `src/scanner/__tests__/extract-session-summary.test.ts` (extended with 4 tests)
- `src/scanner/__tests__/scan-projects.test.ts` (extended with 2 tests)
- `plans/project-scanner.md` (checked off 5 items)

### Notes
- All 411 tests pass (387 parser + 24 scanner), typecheck passes
- All resilience behaviors were already implemented in the source code — this task adds explicit test coverage
- Phase 2 (Edge Cases & Validation) is now fully complete

## 2026-02-20 — Phase 3: Multiple Base Paths

Added test coverage for multi-source scanning with two base paths, including shared directory name deduplication and cross-source sorting.

### What was done
- Created `fixtures/multi-source-base-1/` with two project dirs:
  - `-Users-shared-project/` — session at T1 (2026-02-15)
  - `-Users-alpha-repo/` — session at T3 (2026-02-19, most recent)
- Created `fixtures/multi-source-base-2/` with one project dir:
  - `-Users-shared-project/` — session at T2 (2026-02-17)
- Added 3 tests in `scan-projects.test.ts` under "multiple base paths" describe block:
  - Same directory name under different base paths → 2 separate `ProjectSummary` entries with different `source`
  - Results merged and sorted by `lastActiveAt` descending across all base paths (alpha-repo→base-2/shared→base-1/shared)
  - One missing base path + one valid → returns results from valid path only

### Files changed
- `src/scanner/__tests__/fixtures/multi-source-base-1/-Users-shared-project/aaaa1111-aaaa-aaaa-aaaa-aaaaaaaaaaaa.jsonl` (new)
- `src/scanner/__tests__/fixtures/multi-source-base-1/-Users-alpha-repo/bbbb2222-bbbb-bbbb-bbbb-bbbbbbbbbbbb.jsonl` (new)
- `src/scanner/__tests__/fixtures/multi-source-base-2/-Users-shared-project/cccc3333-cccc-cccc-cccc-cccccccccccc.jsonl` (new)
- `src/scanner/__tests__/scan-projects.test.ts` (extended with 3 tests)
- `plans/project-scanner.md` (checked off 4 items)

### Notes
- All 414 tests pass (387 parser + 27 scanner), typecheck passes
- No source code changes needed — `scanProjects` already handles multiple base paths correctly; this task adds explicit multi-source test coverage
- Fixture timestamps chosen to verify cross-source sorting: T1 (Feb 15) < T2 (Feb 17) < T3 (Feb 19)
