## Unit 0 — Project Scaffolding ✅

- Created `package.json` (name: fleet, type: module, test/typecheck scripts)
- Installed zod@4.3.6, typescript@5.9.3, @types/bun@1.3.9
- Created `tsconfig.json` (strict, esnext, bundler moduleResolution, Bun types)
- Created placeholder `src/parser/index.ts`
- Created smoke test `src/parser/__tests__/smoke.test.ts` (2 tests: import check + sanity)
- Verified: `bun test` passes (2/2), `bun run typecheck` passes (0 errors)

Files changed:
- package.json (new)
- tsconfig.json (new)
- src/parser/index.ts (new)
- src/parser/__tests__/smoke.test.ts (new)

## Unit 1 — Zod Schemas + Inferred Types ✅

- Defined all raw JSONL record schemas in `schemas.ts`: CommonFieldsSchema, TokenUsageSchema, ContentBlockSchema (text/thinking/tool_use), FileHistorySnapshotRecordSchema, UserRecordSchema, AssistantRecordSchema, SystemRecordSchema (.passthrough() for subtype variants), ProgressRecordSchema (.passthrough() for data variants), QueueOperationRecordSchema
- Defined RawRecordSchema as top-level `z.discriminatedUnion("type", [...])` over all 6 record types
- Defined system/progress subtype schemas for precise validation in parseLine: SystemTurnDuration, SystemApiError, SystemLocalCommand, ProgressAgent, ProgressBash, ProgressHook
- Defined all 12 parsed message schemas with `kind` discriminator: file-history-snapshot, user-prompt, user-tool-result, assistant-block, system-turn-duration, system-api-error, system-local-command, progress-agent, progress-bash, progress-hook, queue-operation, malformed
- Defined ParsedMessageSchema as `z.discriminatedUnion("kind", [...])`
- Created `types.ts` with z.infer types for all parsed messages + manual enrichment interfaces: Turn, ReconstitutedResponse, PairedToolCall, TokenTotals, ToolStat, SubagentRef, ContextSnapshot, EnrichedSession
- 57 tests passing (55 schema tests + 2 smoke tests), typecheck clean

Files changed:
- src/parser/schemas.ts (new)
- src/parser/types.ts (new)
- src/parser/__tests__/schemas.test.ts (new)
- plans/transcript-parser.md (updated — Unit 1 checked off)

Learnings:
- Zod v4 (`zod@4.3.6`): `import { z } from "zod"` gives the v4 classic API (re-exported from `./v4/classic/external.js`)
- `.extend()` and `.passthrough()` work in Zod v4 classic and are compatible with `z.discriminatedUnion`
- SystemRecordSchema and ProgressRecordSchema use `.passthrough()` to preserve variant-specific fields through the top-level discriminated union; subtype-specific schemas handle precise validation

## Unit 2 — TRACER BULLET: Minimal End-to-End ✅

- Created `minimal-session.jsonl` fixture (4 lines: file-history-snapshot, user prompt, assistant text, system turn_duration)
- Created `helpers.ts` with fixture builder functions: makeCommonFields, makeFileHistorySnapshot, makeUserPrompt, makeTextBlock, makeThinkingBlock, makeToolUseBlock, makeAssistantRecord, makeTurnDuration, toLine
- Implemented `parseLine` in `parse-line.ts`: validates via RawRecordSchema.safeParse(), handles 4 record types (file-history-snapshot, user string content, assistant, system turn_duration). Empty/blank → null, invalid JSON → MalformedRecord, Zod validation failure → MalformedRecord. Never throws. Unimplemented types (user tool result, progress, queue-operation) return MalformedRecord with descriptive error.
- Implemented `enrichSession` in `enrich-session.ts`: two-pass approach — first pass builds turns from user-prompt messages and assigns turn_duration, second pass groups assistant blocks by messageId into ReconstitutedResponses. Token totals aggregated from deduplicated responses. Empty stubs for toolCalls, toolStats, subagents, contextSnapshots.
- Implemented `parseFullSession` in `parse-full-session.ts`: splits on newline, maps through parseLine, filters nulls, passes to enrichSession
- 75 tests passing (18 new + 57 prior), typecheck clean

Files changed:
- src/parser/parse-line.ts (new)
- src/parser/enrich-session.ts (new)
- src/parser/parse-full-session.ts (new)
- src/parser/__tests__/helpers.ts (new)
- src/parser/__tests__/fixtures/minimal-session.jsonl (new)
- src/parser/__tests__/parse-full-session.test.ts (new)
- plans/transcript-parser.md (updated — Unit 2 checked off)

## Unit 3 — parseLine: User Tool Result ✅

- Updated `parseLine` to handle `user` records with array content → `UserToolResultMessage`
- Maps raw `tool_use_id` / `is_error` fields to camelCase `toolUseId` / `isError`
- Passes through `toolUseResult` metadata (agentId, stats) when present, defaults to `null`
- Added `makeToolResultItem` and `makeUserToolResult` fixture builders to helpers.ts
- 8 new tests: happy path (common fields, results extraction, null toolUseResult, lineIndex), is_error: true, toolUseResult with agentId metadata, multiple results
- 83 tests passing (8 new + 75 prior), typecheck clean

Files changed:
- src/parser/parse-line.ts (updated — user array content handler)
- src/parser/__tests__/helpers.ts (updated — added makeToolResultItem, makeUserToolResult)
- src/parser/__tests__/parse-full-session.test.ts (updated — Unit 3 tests)
- plans/transcript-parser.md (updated — Unit 3 checked off)

## Unit 4 — parseLine: Assistant Block Variants ✅

- Verified `parseLine` already handles thinking and tool_use content blocks generically via Zod's ContentBlockSchema discriminated union — no code changes needed in parse-line.ts
- Verified `isSynthetic` flag already maps from `isApiErrorMessage ?? false`
- Added 13 new tests covering: thinking block extraction (kind, thinking text, signature, common fields, usage), tool_use block extraction (kind, id, name, input, common fields), synthetic flag (isApiErrorMessage: true → isSynthetic: true), default isSynthetic false when absent, empty content array → malformed
- 96 tests passing (13 new + 83 prior), typecheck clean

Files changed:
- src/parser/__tests__/parse-full-session.test.ts (updated — Unit 4 tests)
- plans/transcript-parser.md (updated — Unit 4 checked off)

## Unit 5 — parseLine: System Subtypes ✅

- Added `api_error` case to parseLine system switch: validates via SystemApiErrorSchema, extracts error, retryInMs, retryAttempt, maxRetries
- Added `local_command` case to parseLine system switch: validates via SystemLocalCommandSchema, extracts content
- Unknown system subtypes continue to produce MalformedRecord with subtype name in error message
- Added `makeSystemApiError` and `makeSystemLocalCommand` fixture builders to helpers.ts
- 15 new tests: api_error field extraction (error, retryInMs, retryAttempt, maxRetries, lineIndex), default helper values, missing required fields → MalformedRecord, local_command field extraction (content, lineIndex), missing content → MalformedRecord, unknown subtype → MalformedRecord with error containing subtype name
- 111 tests passing (15 new + 96 prior), typecheck clean

Files changed:
- src/parser/parse-line.ts (updated — api_error and local_command system subtypes)
- src/parser/__tests__/helpers.ts (updated — added makeSystemApiError, makeSystemLocalCommand)
- src/parser/__tests__/parse-full-session.test.ts (updated — Unit 5 tests)
- plans/transcript-parser.md (updated — Unit 5 checked off)
