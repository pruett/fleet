## Unit 0 — Project Scaffolding ✅

- Created `package.json` (name: fleet, type: module, test/typecheck scripts)
- Installed zod@4.3.6, typescript@5.9.3, @types/bun@1.3.9
- Created `tsconfig.json` (strict, esnext, bundler moduleResolution, Bun types)
- Created placeholder `src/parser/index.ts`
- Created smoke test `src/parser/__tests__/smoke.test.ts` (2 tests: import check + sanity)
- Verified: `bun test` passes (2/2), `bun run typecheck` passes (0 errors)

Files changed:
- package.json (new)
- tsconfig.json (new)
- src/parser/index.ts (new)
- src/parser/__tests__/smoke.test.ts (new)

## Unit 1 — Zod Schemas + Inferred Types ✅

- Defined all raw JSONL record schemas in `schemas.ts`: CommonFieldsSchema, TokenUsageSchema, ContentBlockSchema (text/thinking/tool_use), FileHistorySnapshotRecordSchema, UserRecordSchema, AssistantRecordSchema, SystemRecordSchema (.passthrough() for subtype variants), ProgressRecordSchema (.passthrough() for data variants), QueueOperationRecordSchema
- Defined RawRecordSchema as top-level `z.discriminatedUnion("type", [...])` over all 6 record types
- Defined system/progress subtype schemas for precise validation in parseLine: SystemTurnDuration, SystemApiError, SystemLocalCommand, ProgressAgent, ProgressBash, ProgressHook
- Defined all 12 parsed message schemas with `kind` discriminator: file-history-snapshot, user-prompt, user-tool-result, assistant-block, system-turn-duration, system-api-error, system-local-command, progress-agent, progress-bash, progress-hook, queue-operation, malformed
- Defined ParsedMessageSchema as `z.discriminatedUnion("kind", [...])`
- Created `types.ts` with z.infer types for all parsed messages + manual enrichment interfaces: Turn, ReconstitutedResponse, PairedToolCall, TokenTotals, ToolStat, SubagentRef, ContextSnapshot, EnrichedSession
- 57 tests passing (55 schema tests + 2 smoke tests), typecheck clean

Files changed:
- src/parser/schemas.ts (new)
- src/parser/types.ts (new)
- src/parser/__tests__/schemas.test.ts (new)
- plans/transcript-parser.md (updated — Unit 1 checked off)

Learnings:
- Zod v4 (`zod@4.3.6`): `import { z } from "zod"` gives the v4 classic API (re-exported from `./v4/classic/external.js`)
- `.extend()` and `.passthrough()` work in Zod v4 classic and are compatible with `z.discriminatedUnion`
- SystemRecordSchema and ProgressRecordSchema use `.passthrough()` to preserve variant-specific fields through the top-level discriminated union; subtype-specific schemas handle precise validation

## Unit 2 — TRACER BULLET: Minimal End-to-End ✅

- Created `minimal-session.jsonl` fixture (4 lines: file-history-snapshot, user prompt, assistant text, system turn_duration)
- Created `helpers.ts` with fixture builder functions: makeCommonFields, makeFileHistorySnapshot, makeUserPrompt, makeTextBlock, makeThinkingBlock, makeToolUseBlock, makeAssistantRecord, makeTurnDuration, toLine
- Implemented `parseLine` in `parse-line.ts`: validates via RawRecordSchema.safeParse(), handles 4 record types (file-history-snapshot, user string content, assistant, system turn_duration). Empty/blank → null, invalid JSON → MalformedRecord, Zod validation failure → MalformedRecord. Never throws. Unimplemented types (user tool result, progress, queue-operation) return MalformedRecord with descriptive error.
- Implemented `enrichSession` in `enrich-session.ts`: two-pass approach — first pass builds turns from user-prompt messages and assigns turn_duration, second pass groups assistant blocks by messageId into ReconstitutedResponses. Token totals aggregated from deduplicated responses. Empty stubs for toolCalls, toolStats, subagents, contextSnapshots.
- Implemented `parseFullSession` in `parse-full-session.ts`: splits on newline, maps through parseLine, filters nulls, passes to enrichSession
- 75 tests passing (18 new + 57 prior), typecheck clean

Files changed:
- src/parser/parse-line.ts (new)
- src/parser/enrich-session.ts (new)
- src/parser/parse-full-session.ts (new)
- src/parser/__tests__/helpers.ts (new)
- src/parser/__tests__/fixtures/minimal-session.jsonl (new)
- src/parser/__tests__/parse-full-session.test.ts (new)
- plans/transcript-parser.md (updated — Unit 2 checked off)

## Unit 3 — parseLine: User Tool Result ✅

- Updated `parseLine` to handle `user` records with array content → `UserToolResultMessage`
- Maps raw `tool_use_id` / `is_error` fields to camelCase `toolUseId` / `isError`
- Passes through `toolUseResult` metadata (agentId, stats) when present, defaults to `null`
- Added `makeToolResultItem` and `makeUserToolResult` fixture builders to helpers.ts
- 8 new tests: happy path (common fields, results extraction, null toolUseResult, lineIndex), is_error: true, toolUseResult with agentId metadata, multiple results
- 83 tests passing (8 new + 75 prior), typecheck clean

Files changed:
- src/parser/parse-line.ts (updated — user array content handler)
- src/parser/__tests__/helpers.ts (updated — added makeToolResultItem, makeUserToolResult)
- src/parser/__tests__/parse-full-session.test.ts (updated — Unit 3 tests)
- plans/transcript-parser.md (updated — Unit 3 checked off)

## Unit 4 — parseLine: Assistant Block Variants ✅

- Verified `parseLine` already handles thinking and tool_use content blocks generically via Zod's ContentBlockSchema discriminated union — no code changes needed in parse-line.ts
- Verified `isSynthetic` flag already maps from `isApiErrorMessage ?? false`
- Added 13 new tests covering: thinking block extraction (kind, thinking text, signature, common fields, usage), tool_use block extraction (kind, id, name, input, common fields), synthetic flag (isApiErrorMessage: true → isSynthetic: true), default isSynthetic false when absent, empty content array → malformed
- 96 tests passing (13 new + 83 prior), typecheck clean

Files changed:
- src/parser/__tests__/parse-full-session.test.ts (updated — Unit 4 tests)
- plans/transcript-parser.md (updated — Unit 4 checked off)

## Unit 5 — parseLine: System Subtypes ✅

- Added `api_error` case to parseLine system switch: validates via SystemApiErrorSchema, extracts error, retryInMs, retryAttempt, maxRetries
- Added `local_command` case to parseLine system switch: validates via SystemLocalCommandSchema, extracts content
- Unknown system subtypes continue to produce MalformedRecord with subtype name in error message
- Added `makeSystemApiError` and `makeSystemLocalCommand` fixture builders to helpers.ts
- 15 new tests: api_error field extraction (error, retryInMs, retryAttempt, maxRetries, lineIndex), default helper values, missing required fields → MalformedRecord, local_command field extraction (content, lineIndex), missing content → MalformedRecord, unknown subtype → MalformedRecord with error containing subtype name
- 111 tests passing (15 new + 96 prior), typecheck clean

Files changed:
- src/parser/parse-line.ts (updated — api_error and local_command system subtypes)
- src/parser/__tests__/helpers.ts (updated — added makeSystemApiError, makeSystemLocalCommand)
- src/parser/__tests__/parse-full-session.test.ts (updated — Unit 5 tests)
- plans/transcript-parser.md (updated — Unit 5 checked off)

## Unit 6 — parseLine: Progress Subtypes ✅

- Added `progress` case to parseLine with inner switch on `record.data.type` for three subtypes
- `agent_progress`: validates via ProgressAgentSchema, extracts agentId, prompt, parentToolUseID
- `bash_progress`: validates via ProgressBashSchema, extracts output, elapsedTimeSeconds
- `hook_progress`: validates via ProgressHookSchema, extracts hookEvent, hookName, command
- Unknown progress data types produce MalformedRecord with data type name in error message
- Added `makeProgressAgent`, `makeProgressBash`, `makeProgressHook` fixture builders to helpers.ts
- 22 new tests: field extraction for each subtype (agentId, prompt, parentToolUseID, output, elapsedTimeSeconds, hookEvent, hookName, command, lineIndex), default helper values, missing required fields → MalformedRecord for each, unknown data type → MalformedRecord with error containing type name
- 133 tests passing (22 new + 111 prior), typecheck clean

Files changed:
- src/parser/parse-line.ts (updated — progress subtypes: agent_progress, bash_progress, hook_progress)
- src/parser/__tests__/helpers.ts (updated — added makeProgressAgent, makeProgressBash, makeProgressHook)
- src/parser/__tests__/parse-full-session.test.ts (updated — Unit 6 tests)
- plans/transcript-parser.md (updated — Unit 6 checked off)

## Unit 7 — parseLine: Queue Operation + Edge Cases ✅

- Replaced queue-operation stub in parseLine with actual handler: maps `operation` and `content` fields directly from the validated record
- Added `makeQueueOperation` fixture builder to helpers.ts (operation, optional content)
- 17 new tests covering: enqueue with content (kind, operation, content, lineIndex), dequeue without content (kind, operation, content undefined), missing operation field → MalformedRecord, edge cases (empty string → null, whitespace → null, invalid JSON → MalformedRecord, missing type → MalformedRecord, unknown type → MalformedRecord, parseLine never throws for varied inputs), Zod validation catches missing required fields (assistant without message.id, user without sessionId, file-history-snapshot without snapshot)
- **Milestone: parseLine is complete — all 12 message kinds classified, all validated via Zod**
- 150 tests passing (17 new + 133 prior), typecheck clean

Files changed:
- src/parser/parse-line.ts (updated — queue-operation handler)
- src/parser/__tests__/helpers.ts (updated — added makeQueueOperation)
- src/parser/__tests__/parse-full-session.test.ts (updated — Unit 7 tests)
- plans/transcript-parser.md (updated — Unit 7 checked off)

## Unit 8 — enrichSession: Multi-Block Response Reconstitution ✅

- Verified existing `enrichSession` implementation already handles multi-block response reconstitution correctly (grouping by messageId, ordering by lineIndex, taking usage from last block) — no code changes needed in enrich-session.ts
- Created `multi-block-response.jsonl` fixture with 3-block response (thinking → text → tool_use sharing messageId `msg-multi-001`), each with different usage values to verify last-block selection
- 19 new tests across 4 describe blocks:
  - 3-block response fixture: grouping into 1 response, block ordering, usage from last block (output_tokens: 50), model, lineIndexStart/End, turnIndex, responseCount, token totals
  - 2 different messageIds → 2 responses: separate responses, correct messageIds, individual usage, summed totals, responseCount
  - Usage from last block (multi-block): explicit test with 2 blocks sharing messageId, cache token aggregation
  - Synthetic response handling: isSynthetic flag propagation, messageId preservation, non-synthetic default
- 169 tests passing (19 new + 150 prior), typecheck clean

Files changed:
- src/parser/__tests__/fixtures/multi-block-response.jsonl (new — 3-block response fixture)
- src/parser/__tests__/parse-full-session.test.ts (updated — Unit 8 tests + enrichSession import)
- plans/transcript-parser.md (updated — Unit 8 checked off)

## Unit 9 — enrichSession: Tool Call Pairing ✅

- Added tool call pairing to `enrichSession`: iterates assistant-block messages for `tool_use` content blocks, builds a map by toolUseId, then matches with `user-tool-result` results to populate `toolResultBlock`
- Unmatched tool_use blocks get `toolResultBlock: null`
- Updates `toolUseCount` on both individual `Turn` objects and `TokenTotals`
- Created `tool-call-cycle.jsonl` fixture (6 lines: snapshot, user prompt, assistant tool_use, user tool_result, assistant text, turn_duration)
- 19 new tests across 4 describe blocks:
  - Tool call cycle fixture: successful pairing (toolUseId, toolName, input, toolUseBlock, toolResultBlock, turnIndex, toolUseCount in totals and turn, correct responses)
  - Error tool result pairing: isError: true propagation
  - Unmatched tool_use: toolResultBlock is null, still counted in toolUseCount
  - Multiple tool calls across turns: 3 tool calls across 2 turns, correct turnIndex assignments, per-turn toolUseCount
- 188 tests passing (19 new + 169 prior), typecheck clean

Files changed:
- src/parser/enrich-session.ts (updated — tool call pairing logic, PairedToolCall import)
- src/parser/__tests__/fixtures/tool-call-cycle.jsonl (new — tool call cycle fixture)
- src/parser/__tests__/parse-full-session.test.ts (updated — Unit 9 tests)
- plans/transcript-parser.md (updated — Unit 9 checked off)

## Unit 10 — enrichSession: Token Aggregation + Cost ✅

- Created `pricing.ts` with model pricing table covering all Claude model families: Opus (4.5+/legacy), Sonnet, Haiku (4.5/3.5/3). Uses ordered prefix matching on model IDs — unknown models → cost 0.
- `lookupPricing(model)` returns pricing tier or null; `computeCost(input, output, cacheWrite, cacheRead, model)` computes estimated USD cost.
- Updated `enrichSession` to compute `estimatedCostUsd` per-response using `computeCost`, supporting mixed models within the same session.
- Token deduplication by messageId was already handled by response reconstitution (Unit 8) — verified with explicit test.
- 26 new tests across 7 describe blocks: prefix matching (12 model variants + unknown), computeCost (6 cases: known model, opus 4.6, unknown → 0, cache write, cache read, all four components), enrichSession integration (deduplication, cost summation, unknown model → 0, cache token costs, mixed models per-response pricing).
- 214 tests passing (26 new + 188 prior), typecheck clean

Files changed:
- src/parser/pricing.ts (new — model pricing table with lookupPricing and computeCost)
- src/parser/enrich-session.ts (updated — import computeCost, compute estimatedCostUsd per-response)
- src/parser/__tests__/parse-full-session.test.ts (updated — Unit 10 tests + pricing imports)
- plans/transcript-parser.md (updated — Unit 10 checked off)

## Unit 11 — enrichSession: Tool Statistics ✅

- Added tool statistics computation to `enrichSession`: iterates paired tool calls, groups by `toolName`, counts calls and errors, collects error samples with `toolUseId`, `errorText` (stringified content), and `turnIndex`
- Replaced `toolStats: []` stub with computed `toolStats` array from `toolStatMap`
- 8 new tests across 4 describe blocks:
  - Mixed success/error calls: 2 tools (Bash 3 calls/2 errors, Read 1 call/0 errors), correct grouping, error samples with correct fields, empty errorSamples for error-free tools
  - Error samples turnIndex: errors across 2 turns get correct turnIndex (0 and 1)
  - No tool calls: minimal fixture → empty toolStats
  - Unmatched tool_use: counted in stats with 0 errors
- 222 tests passing (8 new + 214 prior), typecheck clean

Files changed:
- src/parser/enrich-session.ts (updated — tool statistics computation from paired tool calls)
- src/parser/__tests__/parse-full-session.test.ts (updated — Unit 11 tests)
- plans/transcript-parser.md (updated — Unit 11 checked off)

## Unit 12 — enrichSession: Context Snapshots ✅

- Added context snapshot computation to `enrichSession`: iterates responses in order, skips synthetic responses, accumulates input and output tokens cumulatively, records a `ContextSnapshot` for each non-synthetic response with messageId, turnIndex, and cumulative token counts
- Replaced `contextSnapshots: []` stub with computed snapshots
- Updated existing tracer bullet test that expected empty contextSnapshots (now that the feature is implemented)
- 12 new tests across 5 describe blocks:
  - Multiple responses: 2 snapshots with cumulative totals, correct messageIds, correct turnIndex
  - Skip synthetic: 3 responses (1 synthetic) → 2 snapshots, synthetic tokens excluded from cumulation
  - Across turns: 2 turns → 2 snapshots with correct turnIndex and cross-turn accumulation
  - No responses: empty input → empty contextSnapshots
  - Minimal fixture: 1 snapshot matching totals, correct messageId and turnIndex
- 234 tests passing (12 new + 222 prior), typecheck clean

Files changed:
- src/parser/enrich-session.ts (updated — context snapshot computation, ContextSnapshot import)
- src/parser/__tests__/parse-full-session.test.ts (updated — Unit 12 tests, fixed tracer bullet test)
- plans/transcript-parser.md (updated — Unit 12 checked off)

## Unit 13 — enrichSession: Subagent References ✅

- Added subagent reference correlation to `enrichSession`: iterates `progress-agent` messages to collect unique `agentId`/`prompt`/`parentToolUseID`, then matches with `user-tool-result` messages carrying `toolUseResult.agentId` to populate stats (`totalDurationMs`, `totalTokens`, `totalToolUseCount`)
- Subagents with no matching tool result (still running) get `stats: null`
- Deduplicates by `agentId` — multiple progress messages for the same agent produce only 1 `SubagentRef`
- Replaced `subagents: []` stub with computed subagents
- Created `subagent-spawn.jsonl` fixture (7 lines: snapshot, user prompt, assistant tool_use Task, progress-agent, user tool-result with toolUseResult stats, assistant text, turn_duration)
- 13 new tests across 5 describe blocks:
  - Subagent spawn fixture: 1 subagent, correct agentId/prompt/parentToolUseID, stats from toolUseResult (totalDurationMs, totalTokens, totalToolUseCount)
  - Still-running subagent: progress-agent without matching tool result → stats: null
  - Multiple subagents mixed completion: 2 subagents — completed has stats, still-running has null
  - No subagents: minimal fixture → empty subagents array
  - Duplicate progress-agent messages: 3 progress messages for same agentId → 1 SubagentRef with stats
- 247 tests passing (13 new + 234 prior), typecheck clean

Files changed:
- src/parser/enrich-session.ts (updated — subagent reference correlation, SubagentRef import)
- src/parser/__tests__/fixtures/subagent-spawn.jsonl (new — subagent spawn cycle fixture)
- src/parser/__tests__/parse-full-session.test.ts (updated — Unit 13 tests)
- plans/transcript-parser.md (updated — Unit 13 checked off)

## Unit 14 — Integration: Multi-Turn Session ✅

- Created `multi-turn-session.jsonl` fixture (18 lines, 3 turns) exercising all 7 enrichments:
  - Turn 0: simple text response (1 response)
  - Turn 1: 2 Bash tool calls (1 success, 1 error) + 1 Task subagent spawn + text response (4 responses)
  - Turn 2: multi-block response with thinking + text sharing messageId (1 response, 2 blocks)
- 31 new tests across 7 describe blocks verifying:
  - 3 turns with correct prompts and durations
  - Response counts per turn (1, 4, 1) and multi-block merging
  - Tool pairing across turns (3 tool calls, all in turn 1, success + error + subagent)
  - Aggregate totals: 1750 input, 320 output, 2070 total tokens, $0.01005 cost
  - Tool stats: Bash (2 calls, 1 error with sample), Task (1 call, 0 errors)
  - Subagent reference: agent-int-001 with completed stats
  - Context snapshots: 6 cumulative snapshots with correct turnIndex and accumulation
- **Milestone: enrichSession is complete — all 7 enrichments working together**
- 278 tests passing (31 new + 247 prior), typecheck clean

Files changed:
- src/parser/__tests__/fixtures/multi-turn-session.jsonl (new — 3-turn integration fixture)
- src/parser/__tests__/parse-full-session.test.ts (updated — Unit 14 integration tests)
- plans/transcript-parser.md (updated — Unit 14 checked off)

## Unit 15 — parseFullSession: Edge Cases ✅

- Added 22 new tests across 7 describe blocks covering parseFullSession edge cases:
  - Empty string → empty session: 0 messages, 0 turns, 0 responses, zero totals, empty enrichment arrays
  - Blank lines only (newlines, spaces, tabs): 0 messages, 0 turns
  - Malformed lines mixed with valid: 3 malformed records preserved with correct lineIndex, valid turn/response still constructed from good lines
  - No human prompt → 0 turns: orphan assistant response still reconstituted, assigned to turnIndex 0
  - Meta-only prompts → 0 turns: isMeta: true user prompts excluded from turn construction, still present in messages
  - Single snapshot line: 1 message (file-history-snapshot), 0 turns, 0 responses
  - Very long lines (100K chars): both user prompt and assistant text block parse and preserve full content
- 300 tests passing (22 new + 278 prior), typecheck clean

Files changed:
- src/parser/__tests__/parse-full-session.test.ts (updated — Unit 15 edge case tests)
- plans/transcript-parser.md (updated — Unit 15 checked off)
